import numpy as np
import cv2
import utm
import os
from docutils.nodes import image
from tqdm import tqdm
from .plot_gps import *
import json
import pandas as pd
import matplotlib
import matplotlib.pyplot as plt

# MAP1_NAME = "../map/high_res_full_UPB_hybrid.jpg"
# CSV1_NAME = "../map/high_res_full_UPB_hybrid.csv"

MAP1_NAME = "../map/high_res_full_UPB_standard.png"
CSV1_NAME = "../map/high_res_full_UPB_standard.csv"
MAP1_SIZE = (10496, 9728)
MAP_REF_POINTS = [
    # ( (row, col), (lat, long) )
    ((1224.0,579.7),(44.443151,26.042875)),
    ((1322.0,2530.0),(44.443062,26.045449)),
    ((1420.0,5817.0),(44.442963,26.049863)),
    ((525.3,8700.0),(44.443825,26.053728)),
    ((3668.5,7893.5),(44.440823,26.052645)),
    ((2361.7,8236.7),(44.442078,26.053105)),
    ((3451.8,6419.0),(44.441029,26.050663)),
    ((4703.3,8968.7),(44.439823,26.054090)),
    ((5707.3,9262.7),(44.438864,26.054484)),
    ((5948.0,9057.3),(44.438622,26.054208)),
    ((6496.0,8293.0),(44.438109,26.053185)),
    ((6320.0,7470.0),(44.438300,26.052072)),
    ((5566.7,7548.7),(44.439000,26.052182)),
    ((4781.8,7101.2),(44.439751,26.051582)),
    ((4459.3,6824.7),(44.440056,26.051220)),
    ((5454.5,6507.5),(44.439122,26.050783)),
    ((3881.0,5220.0),(44.440619,26.049056)),
    ((4933.5,5940.5),(44.439619,26.050021)),
    ((5688.0,5419.3),(44.438892,26.049328)),
    ((5325.0,4359.0),(44.439239,26.047901)),
    ((4936.3,3123.7),(44.439604,26.046250)),
    ((6338.7,4016.0),(44.438262,26.047443)),
    ((6562.0,3840.0),(44.438056,26.047209)),
    ((7234.7,3424.0),(44.437418,26.046646)),
    ((7266.7,3633.7),(44.437380,26.046930)),
    ((7316.7,3831.3),(44.437332,26.047197)),
    ((4086.0,7384.0),(44.437270,26.047535)),
    ((6372.0,5453.3),(44.438240,26.049371)),
    ((6292.0,5585.0),(44.438318,26.049547)),
    ((6486.0,5540.0),(44.438130,26.049483)),
    ((6706.5,6667.5),(44.437926,26.050994)),
    ((6987.7,7190.7),(44.437644,26.051706)),
    ((6891.3,7327.3),(44.437740,26.051883)),
    ((7016.7,5432.7),(44.437613,26.049345)),
    ((7609.5,5283.0),(44.437051,26.049141)),
    ((7913.0,5568.5),(44.436749,26.049531)),
    ((7965.5,5797.5),(44.436689,26.049843)),
    ((8033.0,6004.5),(44.436633,26.050114)),
    ((8199.5,6130.5),(44.436477,26.050282)),
    ((8378.0,6047.3),(44.436313,26.050172)),
    ((8689.0,5509.0),(44.436007,26.049451)),
    ((8688.0,5306.0),(44.436012,26.049175)),
    ((8696.7,4948.0),(44.436003,26.048696)),
    ((8995.3,4892.0),(44.435714,26.048617)),
    ((9253.3,4650.7),(44.435467,26.048299)),
    ((7114.0,2000.0),(44.437516,26.044741)),
    ((7730.7,2460.7),(44.436927,26.045363)),
    ((9361.0,2288.0),(44.435381,26.045123)),
    ((9126.0,2276.0),(44.435604,26.045106)),
    ((9714.0,2295.0),(44.435039,26.045134)),
    ((9139.0,3684.0),(44.435573,26.047003)),
]

class UPB_Map():
    def __init__(self, map_name=MAP1_NAME, csv_name=CSV1_NAME):
        self.map = cv2.imread(map_name)
        self.img_handler = ImageWgsHandler(map_name, csv_name)

    def plot_points(self, Ns: np.array, Es: np.array, img: np.array, radius=20, color=(0.7, 0, 0), verbose=False):
        # downsample
        for i in tqdm(range(Ns.size)):
            row, col = self.img_handler.get_image_coord(Es[i], Ns[i])
            center = (int(col), int(row))
            img = cv2.circle(img, center, color=color, thickness=-1, radius=radius)

        if verbose:
            res_img = cv2.resize(img, None, fx=0.1, fy=0.1)
            cv2.imshow("Map", res_img)
            cv2.waitKey(0)

        return img

if __name__ == "__main__":
    upb = UPB_Map()

    Ns, Es = [], []
    for pt in MAP_REF_POINTS:
        e, n, _, _ = utm.from_latlon(*pt[1])
        Ns.append(n)
        Es.append(e)

    Ns, Es = np.array(Ns), np.array(Es)
    img = upb.plot_points(Ns, Es, img=upb.map, radius=20, color=(255, 0, 0), verbose=False)
    upb.map = img

    cv2.imwrite("trajectories.png", upb.map)